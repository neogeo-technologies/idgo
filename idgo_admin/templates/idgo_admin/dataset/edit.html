{% load bootstrap3 %}

{% include "idgo_admin/alert_messages.html" %}

<form name="dataset" method="post" action="" enctype="multipart/form-data">
  <div class="buttons-on-the-right-side" style="margin-bottom: 20px;">
    {% if dataset %}
    <a class="btn btn-default" href="{% url 'idgo_admin:dataset_mdedit' id=dataset.pk %}">Éditer la fiche de métadonnées INSPIRE</a>
    <a class="btn btn-default" target="_blank" href="{{ CKAN_URL }}/dataset/{{ dataset.slug }}">Ouvrir dans CKAN</a>
    {% endif %}{% if READTHEDOC_URL %}
    <a role="button" class="btn btn-secondary" target="_blank" href="{{ READTHEDOC_URL }}">
      <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> Aide à la saisie
    </a>{% endif %}
  </div>
  {% csrf_token %}
  {% if ENABLE_CKAN_HARVESTER and dataset.remote_ckan_dataset %}
  {% include "idgo_admin/dataset/remote_dataset_frame.html" with remote=dataset.remote_ckan_dataset %}
  {% elif ENABLE_CSW_HARVESTER and dataset.remote_csw_dataset %}
  {% include "idgo_admin/dataset/remote_dataset_frame.html" with remote=dataset.remote_csw_dataset %}
  {% elif ENABLE_DCAT_HARVESTER and dataset.remote_dcat_dataset %}
  {% include "idgo_admin/dataset/remote_dataset_frame.html" with remote=dataset.remote_dcat_dataset %}
  {% endif %}
  <div class="row">
    <div class="col-xs-12">
      {% bootstrap_field form.title %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">
      {% bootstrap_field form.slug %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-8">
      {% bootstrap_field form.description %}
    </div>
    <div class="col-xs-4">
      {% bootstrap_field form.thumbnail %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-12">
      {% bootstrap_field form.keywords %}
    </div>
  </div>
  <br />
  <div class="form-group">
    <label for="categories">Catégories (sélectionnez dans la liste ci-dessous une ou plusieurs catégories)</label>
    <div id="categories" class="btn-group" data-toggle="buttons">
      {% for category in form.categories %}
      <label for="{{ category.id_for_label }}" class="btn">
        {{ category.tag }}
        <span class="badge">{{ category.choice_label }}</span>
      </label>
      {% empty %}
      <p>Aucune catégorie n'est disponible.</p>
      {% endfor %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-4">
      {% bootstrap_field form.date_creation %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-4">
      {% bootstrap_field form.date_modification %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-4">
      {% bootstrap_field form.date_publication %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-4">
      {% bootstrap_field form.update_frequency %}
    </div>
  </div>

  <div class="row">
    <div class="col-xs-4">
      <label for="id_{{ form.geocover.html_name }}">
        {{ form.geocover.label }}
        <button
          id="#id_button_{{ form.geocover.html_name }}"
          type="button" class="btn btn-link"
          data-toggle="collapse" href="#id_popover_{{ form.geocover.html_name }}"
          aria-expanded="false" aria-controls="id_popover_{{ form.geocover.html_name }}">
          <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
        </button>
      </label>
      {% bootstrap_field form.geocover show_label=False %}
    </div>
  </div>

  <div class="collapse" id="id_popover_{{ form.geocover.html_name }}">
    <div class="row">
      <div class="col-xs-12">
        <div class="well">
          <p>
            La couverture géographique d'un jeu de données correspond à son emprise sur le territoire.
            Elle sert à améliorer sa recherche au sein d'un catalogue proposant un filtre spatial.
          </p>
          <p>
            Elle peut être renseignée de plusieurs façons :
            <dl>
              <dt>Calculé automatiquement</dt>
              <dd>
                Chaque fois qu'une ressource géographique est ajoutée au jeu de données,
                son emprise est utilisée pour calculer automatiquement la couverture géographique.
                Si plusieurs ressources géographique sont ajoutées, la couverture du jeu
                de données est la réunion des différentes emprises. Si aucune ressource
                géographique n'est ajoutée au jeu de données, sa couverture géographique est nulle.
              </dd>
              <dt>Régionale</dt>
              <dd>
                La couverture géographique ne dépend pas des ressources ajoutées au jeu de données.
                Elle est toujours égale à l'emprise de la région. Cette option est intéressante
                pour les jeux de données non géographique comportant des données de niveau régional,
                ou bien des jeux de données avec des ressources géographiques concernant l'ensemble
                de la région mais ne disposant d'objets que sur des zones très localisées.
              </dd>
              <dt>Territoire de compétence</dt>
              <dd>
                Il s'agit du territoire de compétence de l'organisation publiant le jeu de données.
                Cette option est la plus adaptée pour les jeux de données ne concernant que le
                territoire restreint associé à l'organisation (commune, communauté de communes,
                département, etc.)
              </dd>
            </dl>
          </p>
        </div>
      </div>
    </div>
  </div>

  {% if dataset.geocover == 'jurisdiction' and not dataset.organisation.jurisdiction %}
  <div class="row">
    <div class="col-xs-8">
      <div class="alert alert-info">
        <span class="glyphicon glyphicon-alert"></span>
        L'organisation à laquelle est rattaché ce jeu de données ne dispose pas de territoire de compétence. Veuillez contacter un administrateur IDGO.
      </div>
    </div>
  </div>
  {% endif %}
  <div class="row">
    <div class="col-xs-4">
      {% bootstrap_field form.granularity %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-8">
      {% bootstrap_field form.organisation %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-8">
      {% bootstrap_field form.license %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-8">
      {% bootstrap_field form.support %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-4">
      {% bootstrap_field form.data_type %}
    </div>
  </div>
  <br />
  <div class="row">
    <div class="col-xs-6">
      {% bootstrap_field form.owner_name %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6">
      {% bootstrap_field form.owner_email %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6">
      {% bootstrap_field form.broadcaster_name %}
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6">
      {% bootstrap_field form.broadcaster_email %}
    </div>
  </div>
  <br />
  {% bootstrap_field form.published %}
  <br />
  <div class="buttons-on-the-right-side">
    <a class="btn btn-default" href="{% url 'idgo_admin:list_my_datasets' %}">Annuler</a>
    <button type="submit" name="continue" class="btn btn-default">Enregistrer et continuer les modifications</button>
    <button type="submit" name="save" class="btn btn-primary">Enregistrer</button>
  </div>
  <hr />
  <div class="row">
    <div class="col-xs-12">
      <small>* Les champs marqués d'un astérisque sont obligatoires.</small>
    </div>
  </div>
</form>
<script>
$(function() {
  $('#id_organisation').change(function() {
    $('#id_license').val({{ licenses|safe }}[$(this).val()]);
  });

  $('.datepicker').datepicker();

  $('form[name="dataset"] input[checked=""], form[name="dataset"] input[checked="checked"]').each(function() {
    $('label[for="' + this.id + '"]').addClass('active');
  });

  const supports = {{ supports | safe }}

  $('select[name="{{ form.support.name }}"]').change(function(e) {
    let name;
    let email;
    if (supports[this.value]) {
      name = supports[this.value]['name'];
      email = supports[this.value]['email'];
    } else {
      name = '{{ DEFAULT_PLATFORM_NAME }}';
      email = '{{ DEFAULT_CONTACT_EMAIL }}';
    };
    $('input[name="{{ form.broadcaster_name.name }}"]').prop('placeholder', name)
    $('input[name="{{ form.broadcaster_email.name }}"]').prop('placeholder', email)
  });


  const $name = $('[name="{{ form.title.name }}"]')
  const $ckanSlug = $('[name="{{ form.slug.name }}"]').prop('readonly', true);

  const btnText = 'Modifier le chemin';
  $ckanSlug.siblings().find('button').text(btnText).click(function(e) {
    if (!$ckanSlug.prop('readonly')) {
      $(this).text(btnText);
      $ckanSlug.prop('readonly', true);
      $ckanSlug.val({% if dataset.slug %}'{{ dataset.slug }}'{% else %}window.slugify($name.val(), 100){% endif %});
    } else {
      $(this).text('Annuler la saisie');
      $ckanSlug.prop('readonly', false);
    };
  });

  {% if not dataset.slug %}
  $name.on('input', function() {
    $ckanSlug.val(window.slugify(this.value, 100))
  });
  {% else %}
    $ckanSlug.val('{{ dataset.slug }}')
  {% endif %}

  function extractor(query) {
    var result = /([^,]+)$/.exec(query);
    if (result && result[1]) {
      return result[1].trim();
    };
    return '';
  };

  $('#dataset .typeahead').typeahead({
    source: {{ tags | safe }},
    updater: function(item) {
      return this.$element.val().replace(/[^,\s]*$/, '') + item + ', ';
    },
    matcher: function (item) {
      var query = extractor(this.query);
      if (!query) {
        return false;
      };
      return ~item.toLowerCase().indexOf(query.toLowerCase())
    },
    highlighter: function (item) {
      var query = extractor(this.query).replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&')
      return item.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
        return '<strong>' + match + '</strong>';
      });
    }
  });

});
</script>
